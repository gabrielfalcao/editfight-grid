#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include "gifenc.h"

static uint8_t palette[] = {
  6,	6,	8,
  20,	16,	19,
  59,	23,	37,
  115,	23,	45,
  180,	32,	42,
  223,	62,	35,
  250,	106,	10,
  249,	163,	27,
  255,	213,	65,
  255,	252,	64,
  214,	242,	100,
  156,	219,	67,
  89,	193,	53,
  20,	160,	46,
  26,	122,	62,
  36,	82,	59,
  18,	32,	32,
  20,	52,	100,
  40,	92,	196,
  36,	159,	222,
  32,	214,	199,
  166,	252,	219,
  255,	255,	255,
  254,	243,	192,
  250,	214,	184,
  245,	160,	151,
  232,	106,	115,
  188,	74,	155,
  121,	58,	128,
  64,	51,	83,
  36,	34,	52,
  34,	28,	26,
  50,	43,	40,
  113,	65,	59,
  187,	117,	71,
  219,	164,	99,
  244,	210,	156,
  218,	224,	234,
  179,	185,	209,
  139,	147,	175,
  109,	117,	141,
  74,	84,	98,
  51,	57,	65,
  66,	36,	51,
  91,	49,	56,
  142,	82,	82,
  186,	117,	106,
  233,	181,	163,
  227,	230,	255,
  185,	191,	251,
  132,	155,	228,
  88,	141,	190,
  71,	125,	133,
  35,	103,	78,
  50,	132,	100,
  93,	175,	141,
  146,	220,	186,
  205,	247,	226,
  228,	210,	170,
  199,	176,	139,
  160,	134,	98,
  121,	103,	85,
  90,	78,	68,
  66,	57,	52,
};

static uint8_t logo[] = {
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 12, 12, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 12, 0, 12, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 2, 2, 0, 2, 2, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 12, 12, 12, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 12, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 12, 12, 2, 2, 2, 2, 0, 0, 0, 12, 2, 2, 0, 0, 0, 12, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 12, 12, 0, 12, 2, 2, 2, 2, 2, 2, 2, 0, 0, 12, 2, 2, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0,
  0, 0, 0, 0, 12, 12, 12, 12, 2, 2, 12, 2, 2, 0, 0, 0, 2, 2, 2, 0, 0, 2, 2, 0, 0, 0, 0, 12, 2, 2, 0, 0, 0, 0, 0, 2, 2, 2, 12, 12, 12, 0,
  0, 12, 12, 12, 12, 2, 2, 2, 2, 2, 0, 2, 2, 2, 0, 0, 0, 2, 2, 0, 0, 12, 2, 2, 0, 0, 0, 0, 2, 2, 0, 0, 2, 2, 2, 2, 12, 12, 12, 12, 12, 0,
  0, 12, 2, 2, 2, 2, 2, 2, 0, 0, 0, 12, 2, 2, 0, 0, 0, 12, 2, 2, 0, 12, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 12, 12, 12, 12, 12, 0, 0, 0, 0,
  0, 12, 2, 2, 2, 12, 12, 12, 0, 0, 0, 12, 2, 2, 0, 0, 12, 12, 2, 2, 0, 0, 2, 2, 0, 0, 0, 0, 2, 2, 0, 0, 0, 12, 12, 12, 2, 12, 12, 0, 0, 0,
  0, 0, 2, 2, 12, 12, 2, 2, 2, 0, 0, 0, 2, 2, 12, 12, 12, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 12, 12, 0, 0, 0, 0, 0, 2, 12, 12, 0, 0, 0,
  0, 0, 12, 2, 2, 2, 2, 2, 2, 0, 0, 0, 12, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 2, 2, 0, 0, 2, 12, 12, 0, 0, 0, 0, 0, 0, 12, 12, 0, 0, 0,
  0, 0, 12, 2, 2, 2, 2, 0, 12, 12, 0, 0, 12, 2, 2, 2, 2, 2, 0, 0, 2, 2, 0, 0, 2, 12, 12, 0, 2, 12, 12, 12, 0, 0, 0, 0, 0, 2, 12, 12, 0, 0,
  0, 0, 0, 2, 2, 12, 12, 12, 12, 2, 2, 0, 0, 2, 2, 0, 0, 0, 2, 2, 2, 12, 12, 0, 2, 12, 12, 2, 2, 12, 12, 12, 0, 0, 0, 0, 0, 2, 12, 12, 0, 0,
  0, 0, 0, 12, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 2, 12, 12, 12, 12, 0, 0, 12, 12, 12, 12, 12, 12, 12, 0, 0, 0, 0, 0, 0, 12, 12, 0, 0,
  0, 0, 0, 12, 2, 2, 2, 2, 2, 0, 0, 0, 2, 2, 0, 0, 2, 2, 12, 12, 12, 0, 0, 0, 0, 2, 12, 12, 12, 0, 12, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 2, 2, 0, 0, 0, 2, 2, 0, 2, 12, 12, 0, 2, 12, 12, 0, 0, 2, 2, 2, 0, 0, 12, 12, 0, 0, 2, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 12, 12, 2, 12, 12, 0, 0, 12, 12, 0, 0, 2, 12, 12, 12, 0, 2, 12, 12, 0, 0, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 2, 2, 2, 12, 12, 12, 12, 12, 0, 12, 12, 0, 0, 2, 12, 12, 0, 0, 12, 12, 12, 12, 2, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 2, 12, 12, 12, 12, 12, 0, 0, 0, 2, 12, 12, 0, 2, 12, 12, 0, 0, 2, 2, 12, 12, 0, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 2, 12, 12, 0, 0, 2, 2, 0, 0, 2, 12, 12, 0, 0, 12, 12, 2, 2, 2, 12, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 12, 12, 2, 2, 2, 12, 12, 0, 0, 12, 12, 0, 0, 0, 12, 12, 12, 12, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 2, 12, 12, 12, 12, 12, 12, 0, 0, 2, 12, 12, 0, 0, 0, 12, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 2, 12, 12, 12, 12, 0, 0, 0, 0, 2, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 12, 12, 0, 0, 0, 0, 0, 0, 0, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 2, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 2, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 12, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
};

static int logo_w = 42, logo_h = 30;

int main(int argc, char **argv) {
  if (argc < 4) {
    fprintf(stderr, "Usage: ./make-gif <time-lapse-file> <output-gif-file> <period in seconds, eg 30>\n");
    return 1;
  }

  int period = atoi(argv[3]);

  FILE *file = fopen(argv[1], "rb");
  unsigned char buffer[11];
  size_t bytesRead = 0;
  double last = 0;

  ge_GIF *gif = ge_new_gif(
    argv[2],
    1000, 1000,
    palette, 6,
    0
  );

  uint8_t *canvas = calloc(1000 * 1000, sizeof(uint8_t));

  for (int y = 0; y < logo_h; y++) {
    for (int x = 0; x < logo_w; x++) {
      canvas[y * 1000 + x] = logo[y * logo_w + x];
    }
  }

  while ((bytesRead = fread(buffer, sizeof(buffer), 1, file)) > 0) {
    uint8_t x = buffer[0];
    uint8_t y = buffer[1];
    uint8_t c = buffer[2];
    double t = *((double*)(buffer + 3));

    for (int y2 = 0; y2 < 10; y2++) {
      for (int x2 = 0; x2 < 10; x2++) {
        canvas[(y * 10 + y2) * 1000 + (x * 10 + x2)] = c;
      }
    }

    if (t - last > 1000.0 * period) {
      memcpy(gif->frame, canvas, 1000 * 1000);
      ge_add_frame(gif, 1);

      printf(".");
      fflush(stdout);

      last = t;
    }
  }

  fclose(file);

  memcpy(gif->frame, canvas, 1000 * 1000);
  ge_add_frame(gif, 1000);
  ge_close_gif(gif);

  return 0;
}